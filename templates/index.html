<!doctype html>
<html>
<head>
  <title>Patient Matcher</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="mb-4">
    Total Suggested Matches
    <span id="matches-counter" class="badge bg-primary">{{ matches|length }}</span>
  </h1>

  {% for match in matches %}
    {% set ext_id = match.external | attribute('patient_id') %}
    {% set int_id = match.internal | attribute('patient_id') %}
    {% set match_id = "match-card-" ~ ext_id ~ "-" ~ int_id %}

    <div class="card mb-4" id="{{ match_id }}">
      <div class="card-body">
        <h5 class="card-title">Match Score: {{ match.score }}</h5>

        <div class="row">
          <div class="col-md-6">
            <h6>External Patient</h6>
            <div class="card bg-light">
              <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <button class="btn btn-outline-secondary btn-sm"
                          type="button"
                          data-patient='{{ match.external|tojson|safe }}'
                          onclick="copyPatientJsonFromButton(this, 'External Patient')">
                    Copy as JSON
                  </button>
                </div>
                {% for field in patient_fields %}
                  {% set ext_value = match.external | attribute(field) %}
                  {% set norm_field = field ~ '_norm' %}
                  {% set ext_norm = match.external | attribute(norm_field, None) %}
                  {% set int_norm = match.internal | attribute(norm_field, None) %}
                  <div class="row mb-1">
                    <div class="d-flex w-100
                      {% if ext_norm and int_norm and ext_norm != int_norm %}
                        bg-warning-subtle border border-warning rounded px-2 py-1
                      {% endif %}
                    ">
                      <div class="col-4"><strong>{{ field | camel_to_title }}:</strong></div>
                      <div class="col-8">
                        <span
                          {% if ext_norm and int_norm and ext_norm != int_norm %}
                            data-bs-toggle="tooltip" title="Normalized value differs!"
                          {% endif %}
                        >
                          {{ ext_value }}
                          {% if ext_norm and int_norm and ext_norm != int_norm %}
                            <span class="ms-1 text-warning">&#9888;</span>
                          {% endif %}
                        </span>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <h6>Internal Patient</h6>
            <div class="card bg-light">
              <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <button class="btn btn-outline-secondary btn-sm"
                          type="button"
                          data-patient='{{ match.internal|tojson|safe }}'
                          onclick="copyPatientJsonFromButton(this, 'Internal Patient')">
                    Copy as JSON
                  </button>
                </div>
                {% for field in patient_fields %}
                  {% set int_value = match.internal | attribute(field) %}
                  {% set norm_field = field ~ '_norm' %}
                  {% set ext_norm = match.external | attribute(norm_field, None) %}
                  {% set int_norm = match.internal | attribute(norm_field, None) %}
                  <div class="row mb-1">
                    <div class="d-flex w-100
                      {% if ext_norm and int_norm and ext_norm != int_norm %}
                        bg-warning-subtle border border-warning rounded px-2 py-1
                      {% endif %}
                    ">
                      <div class="col-4"><strong>{{ field | camel_to_title }}:</strong></div>
                      <div class="col-8">
                        <span
                          {% if ext_norm and int_norm and ext_norm != int_norm %}
                            data-bs-toggle="tooltip" title="Normalized value differs!"
                          {% endif %}
                        >
                          {{ int_value }}
                          {% if ext_norm and int_norm and ext_norm != int_norm %}
                            <span class="ms-1 text-warning">&#9888;</span>
                          {% endif %}
                        </span>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <button class="btn btn-success btn-sm me-2"
                  onclick="acceptMatch('{{ ext_id }}', '{{ int_id }}')">
            Accept
          </button>
          <button class="btn btn-danger btn-sm"
                  onclick="removeMatchCard('{{ ext_id }}', '{{ int_id }}')">
            Reject
          </button>
          <!-- Score Breakdown Button with Info Tooltip -->
          <button class="btn btn-secondary btn-sm ms-2"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#breakdown-{{ ext_id }}-{{ int_id }}"
                  aria-expanded="false"
                  aria-controls="breakdown-{{ ext_id }}-{{ int_id }}"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="See how the match score was calculated, including field-by-field similarity and penalties.">
            Show Score Breakdown
            <span class="badge rounded-circle bg-info text-dark ms-1" style="cursor: pointer;">i</span>
          </button>
        </div>
        <!-- Collapsible Breakdown Section -->
        <div class="collapse mt-3" id="breakdown-{{ ext_id }}-{{ int_id }}">
          <div class="card card-body">
            <h6>Score Breakdown</h6>
            <div class="table-responsive mb-2">
              <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Field</th>
                    <th>Similarity</th>
                    <th>Weight</th>
                    <th>Weighted Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for field, info in match.breakdown.fields.items() %}
                    <tr>
                      <td><strong>{{ field|camel_to_title }}</strong></td>
                      <td>{{ info.similarity|round(3) }}</td>
                      <td>{{ info.weight }}</td>
                      <td>{{ info.weighted_score|round(3) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div>
              <strong>Final Score:</strong> {{ match.breakdown.final_score|round(3) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='app.js') }}"></script>

</body>
</html>